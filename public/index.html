<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LANDOLT GOMOKU ONLINE</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --bg: #0f172a; --panel: #ffffff; --green: #064e3b; --accent: #2563eb; --red: #dc2626; }
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); height: 100vh; overflow: hidden; display: flex; justify-content: center; }
        .app { width: 100%; max-width: 500px; height: 100%; background: var(--panel); display: flex; flex-direction: column; position: relative; }

        /* LOBBY UI */
        #lobby { flex: 1; display: flex; flex-direction: column; padding: 20px; overflow: hidden; }
        .create-form { background: #f1f5f9; padding: 15px; border-radius: 12px; margin-bottom: 15px; flex-shrink: 0; }
        input { width: 100%; padding: 12px; margin-bottom: 8px; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; outline: none; }
        
        .list-container { 
            flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; 
            border: 1px solid #e2e8f0; border-radius: 12px; padding: 10px;
            background: #fff;
        }
        .room-item { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .room-item b { font-size: 16px; color: #1e293b; }

        /* GAME UI */
        #game { display: none; flex-direction: column; height: 100%; touch-action: none; position: absolute; inset: 0; z-index: 10; background: #fff; }
        .game-header { padding: 10px 15px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        #canvas-wrap { flex: 1; background: var(--green); position: relative; overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; }

        .game-footer { padding: 15px 20px 45px 20px; border-top: 1px solid #ddd; background: #fff; }
        .dir-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .dir-btn { height: 55px; border: 2px solid #e2e8f0; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; cursor: pointer; }
        .dir-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
        .leave-btn { width: 100%; padding: 10px; font-size: 20px; font-weight: bold; color: var(--red); border: none; background: none; }
    </style>
</head>
<body>

<div class="app">
    <div id="lobby">
        <h2 style="margin-bottom:15px; text-align:center;">LANDOLT ONLINE</h2>
        <div class="create-form">
            <input type="text" id="c-id" placeholder="„É´„Éº„É†Âêç">
            <input type="password" id="c-pw" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ(‰ªªÊÑè)">
            <button onclick="createRoom()" style="width:100%; padding:12px; background:var(--accent); color:#fff; border:none; border-radius:8px; font-weight:bold;">„É´„Éº„É†„Çí‰ΩúÊàê</button>
        </div>
        <input type="text" id="search" placeholder="üîç „É´„Éº„É†„ÇíÊ§úÁ¥¢..." oninput="renderRooms()" style="margin-bottom:10px;">
        <div class="list-container" id="list-target"></div>
    </div>

    <div id="game">
        <div class="game-header">
            <div><b id="ui-room">---</b><br><small id="ui-status" style="font-weight:bold;">CONNECTING...</small></div>
            <div id="ui-pairs" style="font-weight:900; color:var(--accent);">PAIRS: 0 / 0</div>
        </div>
        <div id="canvas-wrap"><canvas id="stage"></canvas></div>
        <div class="game-footer">
            <div class="dir-grid">
                <div id="db0" class="dir-btn active" onclick="setDir(0)">‚Üë</div>
                <div id="db1" class="dir-btn" onclick="setDir(1)">‚Üí</div>
                <div id="db2" class="dir-btn" onclick="setDir(2)">‚Üì</div>
                <div id="db3" class="dir-btn" onclick="setDir(3)">‚Üê</div>
            </div>
            <button class="leave-btn" onclick="location.reload()">LEAVE GAME</button>
        </div>
    </div>
</div>

<script>
    const socket = io();
    const cvs = document.getElementById('stage');
    const ctx = cvs.getContext('2d', { alpha: false });
    const wrap = document.getElementById('canvas-wrap');

    let g_rooms = [], g_side = null, g_turn = 0, g_board = [], g_pairs = [0, 0], g_active = false;
    let cam = { x: 64, y: 64, zoom: 1.0 }, selDir = 0, touches = new Map(), isDrag = false;

    // --- Lobby ---
    socket.on('updateRoomList', list => { g_rooms = list; renderRooms(); });
    function renderRooms() {
        const target = document.getElementById('list-target');
        const q = document.getElementById('search').value.toLowerCase();
        target.innerHTML = "";
        const filtered = g_rooms.filter(r => r.id.toLowerCase().includes(q));
        if(!filtered.length) { target.innerHTML = "<p style='text-align:center; padding:20px; color:#94a3b8;'>„É´„Éº„É†„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>"; return; }
        filtered.forEach(r => {
            const div = document.createElement('div');
            div.className = 'room-item';
            div.innerHTML = `<div><b>${r.id}</b><p>${r.status} (${r.playerCount}/2)</p></div>
                             <button onclick="joinRoom('${r.id}', ${r.hasPw})" style="padding:10px 18px; background:var(--green); color:#fff; border:none; border-radius:8px; font-weight:bold;">ÂèÇÂä†</button>`;
            target.appendChild(div);
        });
    }
    function createRoom() {
        const id = document.getElementById('c-id').value;
        const pw = document.getElementById('c-pw').value;
        if(id) socket.emit('createRoom', { roomId: id, password: pw, settings: { timeLimit: 60 } });
    }
    function joinRoom(id, hp) {
        const pw = hp ? prompt("„Éë„Çπ„ÉØ„Éº„Éâ:") : "";
        if(pw !== null) socket.emit('joinRoom', { roomId: id, password: pw });
    }

    // --- Game Engine Sync ---
    socket.on('roomJoined', d => {
        g_side = d.playerIndex;
        document.getElementById('game').style.display = 'flex';
        document.getElementById('ui-room').textContent = d.roomId;
        resize();
    });
    socket.on('gameStart', () => { g_active = true; uiSync(); draw(); });
    socket.on('moveMade', d => {
        g_board.push(d.piece); g_turn = d.nextTurn; g_pairs = d.consecutivePairs;
        uiSync(); draw();
    });
    socket.on('gameOver', d => { alert(d.winner === g_side ? "ÂãùÂà©„Åó„Åæ„Åó„ÅüÔºÅ" : "ÊïóÂåó„Åó„Åæ„Åó„Åü..."); location.reload(); });
    socket.on('playerLeft', () => { alert("Áõ∏Êâã„ÅåÈÄÄÂá∫„Åó„Åæ„Åó„Åü"); location.reload(); });
    socket.on('error_msg', m => alert(m));

    // --- Render Logic ---
    function draw() {
        if (!cvs.width) return;
        ctx.fillStyle = "#020617"; ctx.fillRect(0, 0, cvs.width, cvs.height);
        const s = 45 * cam.zoom;
        const ox = cvs.width / 2 - cam.x * s, oy = cvs.height / 2 - cam.y * s;
        ctx.fillStyle = "#064e3b"; ctx.fillRect(ox, oy, 128 * s, 128 * s);
        ctx.strokeStyle = "rgba(255,255,255,0.08)"; ctx.beginPath();
        for (let i = 0; i <= 128; i++) {
            ctx.moveTo(ox + i * s, oy); ctx.lineTo(ox + i * s, oy + 128 * s);
            ctx.moveTo(ox, oy + i * s); ctx.lineTo(ox + 128 * s, oy + i * s);
        }
        ctx.stroke();
        g_board.forEach(p => {
            const px = ox + p.x * s + s/2, py = oy + p.y * s + s/2;
            ctx.beginPath(); ctx.arc(px, py, s * 0.35, 0, Math.PI * 2);
            ctx.strokeStyle = p.player === 0 ? "#000" : "#fff"; ctx.lineWidth = s * 0.1; ctx.stroke();
            ctx.beginPath(); const a = [-Math.PI/2, 0, Math.PI/2, Math.PI][p.direction];
            ctx.arc(px, py, s * 0.35, a - 0.4, a + 0.4); ctx.strokeStyle = "#fbbf24"; ctx.lineWidth = s * 0.12; ctx.stroke();
        });
    }

    // --- Interaction (Fixed Mobile Logic) ---
    wrap.addEventListener('touchstart', e => {
        e.preventDefault(); 
        if (e.touches.length === 1) {
            isDrag = false;
            touches.set(e.touches[0].identifier, { x: e.touches[0].clientX, y: e.touches[0].clientY });
        } else if (e.touches.length === 2) {
            wrap.lastDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
        }
    }, { passive: false });

    wrap.addEventListener('touchmove', e => {
        e.preventDefault();
        if (e.touches.length === 1) {
            const t = e.touches[0];
            const last = touches.get(t.identifier);
            if (last) {
                const dx = t.clientX - last.x, dy = t.clientY - last.y;
                if (Math.abs(dx) > 5 || Math.abs(dy) > 5) isDrag = true;
                cam.x -= dx / (45 * cam.zoom); cam.y -= dy / (45 * cam.zoom);
                touches.set(t.identifier, { x: t.clientX, y: t.clientY });
                draw();
            }
        } else if (e.touches.length === 2) {
            const d = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
            const factor = d / wrap.lastDist;
            cam.zoom = Math.min(Math.max(cam.zoom * factor, 0.4), 3.0);
            wrap.lastDist = d;
            draw();
        }
    }, { passive: false });

    wrap.addEventListener('touchend', e => {
        if (!isDrag && e.changedTouches.length === 1) {
            const t = e.changedTouches[0];
            const r = cvs.getBoundingClientRect();
            onBoardClick(t.clientX - r.left, t.clientY - r.top);
        }
        for (let t of e.changedTouches) touches.delete(t.identifier);
    });

    function onBoardClick(sx, sy) {
        if (!g_active || g_turn !== g_side) return;
        const s = 45 * cam.zoom;
        const gx = Math.floor((sx - (cvs.width / 2 - cam.x * s)) / s);
        const gy = Math.floor((sy - (cvs.height / 2 - cam.y * s)) / s);
        if (gx < 0 || gx >= 128 || gy < 0 || gy >= 128 || g_board.find(p => p.x === gx && p.y === gy)) return;

        let isPairMove = false;
        const lastOpp = g_board.filter(p => p.player !== g_side).pop();
        if (lastOpp) {
            const dx = gx - lastOpp.x, dy = gy - lastOpp.y;
            if ((lastOpp.direction === 0 && dy === -1 && dx === 0) || (lastOpp.direction === 1 && dx === 1 && dy === 0) || (lastOpp.direction === 2 && dy === 1 && dx === 0) || (lastOpp.direction === 3 && dx === -1 && dy === 0)) isPairMove = true;
        }
        if (isPairMove && g_pairs[g_side] >= 3) return alert("ÈÄ£Á∂ö„ÅÆÂØæ„ÅØ3Âõû„Åæ„Åß„Åß„Åô");

        const np = [...g_pairs]; np[g_side] = isPairMove ? np[g_side] + 1 : 0;
        const piece = { x: gx, y: gy, direction: selDir, player: g_side };
        socket.emit('placePiece', { roomId: document.getElementById('ui-room').textContent, piece, consecutivePairs: np });
        if (winCheck(g_board.concat(piece), g_side)) socket.emit('declareWin', { roomId: document.getElementById('ui-room').textContent, winner: g_side });
    }

    // --- Win Conditions ---
    function winCheck(all, side) {
        const mine = all.filter(m => m.player === side);
        const dirs = [[1, 0], [0, 1], [1, 1], [1, -1]];
        for (let m of mine) {
            for (let [vx, vy] of dirs) {
                let chain = [m];
                for (let i = 1; i < 5; i++) {
                    const f = mine.find(x => x.x === m.x + vx * i && x.y === m.y + vy * i);
                    if (f) chain.push(f); else break;
                }
                if (chain.length >= 5) {
                    if (chain.some(c => all.some(o => o !== c && isPairRelation(c, o)))) return true;
                }
            }
        }
        return false;
    }
    function isPairRelation(a, b) {
        const dx = b.x - a.x, dy = b.y - a.y;
        if (dx === 0 && dy === -1) return a.direction === 0 && b.direction === 2;
        if (dx === 1 && dy === 0) return a.direction === 1 && b.direction === 3;
        if (dx === 0 && dy === 1) return a.direction === 2 && b.direction === 0;
        if (dx === -1 && dy === 0) return a.direction === 3 && b.direction === 1;
        return false;
    }

    function uiSync() {
        const st = document.getElementById('ui-status');
        st.textContent = g_turn === g_side ? "‚òÖ „ÅÇ„Å™„Åü„ÅÆÁï™" : "Áõ∏Êâã„ÅÆÁï™";
        st.style.color = g_turn === g_side ? "var(--accent)" : "#666";
        document.getElementById('ui-pairs').textContent = `PAIRS: ${g_pairs[0]} / ${g_pairs[1]}`;
    }
    function setDir(d) { selDir = d; document.querySelectorAll('.dir-btn').forEach((b, i) => b.classList.toggle('active', i === d)); }
    function resize() { cvs.width = wrap.clientWidth; cvs.height = wrap.clientHeight; draw(); }
    window.onresize = resize;
</script>
</body>
</html>


