<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒ©ãƒ³ãƒ‰ãƒ«ãƒˆç’°äº”ç›®ä¸¦ã¹ ONLINE</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: none; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f4f8;
            height: 100vh;
            display: flex;
            justify-content: center;
            overflow: hidden;
        }

        .app-container {
            background-color: #ffffff;
            width: 100vw;
            max-width: 600px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* --- ãƒ­ãƒ“ãƒ¼ç”»é¢ --- */
        #lobbyScreen {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .lobby-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .lobby-header h1 {
            color: #2d3748;
            font-size: 24px;
        }

        .card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        }

        .card h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #4a5568;
        }

        input, select {
            width: 100%;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 16px;
        }

        .primary-btn {
            width: 100%;
            padding: 14px;
            background-color: #3182ce;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
        }

        .primary-btn:hover { background-color: #2b6cb0; }

        /* æ¤œç´¢ãƒãƒ¼ */
        .search-area {
            position: sticky;
            top: 0;
            background: #ffffff;
            padding: 10px 0;
            z-index: 10;
        }

        #searchInput {
            margin-bottom: 0;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>');
            background-repeat: no-repeat;
            background-position: 12px center;
            padding-left: 40px;
        }

        /* ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆ */
        .room-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #edf2f7;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .room-item:hover {
            border-color: #3182ce;
            background-color: #f7fafc;
        }

        .room-name { font-weight: bold; color: #2d3748; }
        .room-meta { font-size: 12px; color: #718096; }

        .join-btn {
            padding: 8px 16px;
            background-color: #48bb78;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }

        .join-btn:disabled {
            background-color: #cbd5e1;
            cursor: not-allowed;
        }

        /* --- ã‚²ãƒ¼ãƒ ç”»é¢ --- */
        #gameScreen {
            display: none;
            flex: 1;
            flex-direction: column;
        }

        .game-nav {
            padding: 10px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #canvasContainer {
            flex: 1;
            background-color: #1a3a3a;
            position: relative;
            overflow: hidden;
        }

        canvas { display: block; width: 100%; height: 100%; }

        .game-ui {
            padding: 20px;
            background-color: white;
            border-top: 1px solid #e2e8f0;
        }

        .direction-panel {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .dir-btn {
            width: 55px;
            height: 55px;
            border: 2px solid #e2e8f0;
            background-color: white;
            border-radius: 12px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }

        .dir-btn.active {
            border-color: #3182ce;
            color: #3182ce;
            background-color: #ebf8ff;
        }

        .footer-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        /* æ„Ÿæƒ³æˆ¦UI */
        #reviewPanel {
            display: none;
            text-align: center;
            padding: 15px;
            border-top: 2px dashed #cbd5e1;
            margin-top: 10px;
        }

        .rev-btn {
            padding: 10px 20px;
            background-color: #4a5568;
            color: white;
            border: none;
            border-radius: 8px;
            margin: 0 8px;
            cursor: pointer;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active { display: flex; }

        .modal-card {
            background: white;
            padding: 30px;
            border-radius: 16px;
            width: 85%;
            max-width: 400px;
            text-align: center;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="lobbyScreen">
        <div class="lobby-header">
            <h1>ãƒ©ãƒ³ãƒ‰ãƒ«ãƒˆç’°äº”ç›®ä¸¦ã¹</h1>
        </div>

        <div class="card">
            <h3>å¯¾å±€å®¤ã‚’ä½œã‚‹</h3>
            <input type="text" id="createRoomName" placeholder="ãƒ«ãƒ¼ãƒ åï¼ˆå¿…é ˆï¼‰">
            <input type="password" id="createRoomPass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰">
            <select id="createTimeLimit">
                <option value="10">åˆ¶é™æ™‚é–“: 10ç§’</option>
                <option value="30" selected>åˆ¶é™æ™‚é–“: 30ç§’</option>
                <option value="60">åˆ¶é™æ™‚é–“: 60ç§’</option>
                <option value="free">ç„¡åˆ¶é™</option>
            </select>
            <button class="primary-btn" onclick="handleCreateRoom()">ãƒ«ãƒ¼ãƒ ä½œæˆ</button>
        </div>

        <div class="search-area">
            <input type="text" id="searchInput" placeholder="ãƒ«ãƒ¼ãƒ åã§æ¤œç´¢..." oninput="renderRoomList()">
        </div>

        <div id="roomListContainer" style="margin-top: 15px;">
            </div>
    </div>

    <div id="gameScreen">
        <div class="game-nav">
            <div>
                <b id="uiRoomName">---</b><br>
                <span id="uiGameStatus" style="font-size: 12px; color: #718096;">å¾…æ©Ÿä¸­</span>
            </div>
            <div id="uiTimer" style="font-size: 28px; font-weight: bold; color: #e53e3e;">--</div>
        </div>

        <div id="canvasContainer">
            <canvas id="gameCanvas"></canvas>
        </div>

        <div class="game-ui">
            <div class="direction-panel" id="dirBtns">
                <button class="dir-btn active" onclick="changeDirection(0)">â†‘</button>
                <button class="dir-btn" onclick="changeDirection(1)">â†’</button>
                <button class="dir-btn" onclick="changeDirection(2)">â†“</button>
                <button class="dir-btn" onclick="changeDirection(3)">â†</button>
            </div>

            <div id="reviewPanel">
                <p style="margin-bottom: 10px; font-weight: bold;">æ„Ÿæƒ³æˆ¦ãƒ¢ãƒ¼ãƒ‰</p>
                <button class="rev-btn" onclick="navigateReview(-1)">â—€ å‰ã®æ‰‹</button>
                <span id="reviewStepLabel" style="font-weight: bold;">0 / 0</span>
                <button class="rev-btn" onclick="navigateReview(1)">æ¬¡ã®æ‰‹ â–¶</button>
            </div>

            <div class="footer-info">
                <span id="uiPairInfo">é€£ç¶šå¯¾: é»’0/3 ç™½0/3</span>
                <button onclick="location.reload()" style="color: #e53e3e; background: none; border: none; font-weight: bold; cursor: pointer;">é€€å‡º</button>
            </div>
        </div>
    </div>
</div>

<div id="endModal" class="modal-overlay">
    <div class="modal-card">
        <h2 id="modalTitle">å¯¾å±€çµ‚äº†</h2>
        <p id="modalDescription" style="margin: 15px 0; color: #4a5568;"></p>
        <button class="primary-btn" style="margin-bottom: 10px;" onclick="startReviewMode()">æ„Ÿæƒ³æˆ¦ã‚’é–‹å§‹</button>
        <button class="primary-btn" style="background-color: #718096;" onclick="location.reload()">ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹</button>
    </div>
</div>

<script>
    const socket = io();
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // --- ã‚²ãƒ¼ãƒ ç”¨å¤‰æ•° ---
    const GRID_SIZE = 128;
    const CELL_SIZE = 40;
    
    let allPublicRooms = []; // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å—ä¿¡ã—ãŸå…¨ãƒ‡ãƒ¼ã‚¿
    let currentRoomId = "";
    let myPlayerIndex = null; // 0 or 1
    let gamePieces = [];      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›¤é¢
    let gameHistory = [];     // å…¨å±¥æ­´ï¼ˆæ„Ÿæƒ³æˆ¦ç”¨ï¼‰
    let currentTurn = 0;
    let pairsCount = [0, 0];
    
    let vX = 64, vY = 64;     // ã‚«ãƒ¡ãƒ©ä½ç½®ï¼ˆã‚°ãƒªãƒƒãƒ‰åº§æ¨™ï¼‰
    let zoom = 1.0;
    let selectedDir = 0;      // 0:ä¸Š, 1:å³, 2:ä¸‹, 3:å·¦
    let isReviewing = false;
    let reviewPointer = 0;
    let isGameActive = false;

    // --- 1. ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆè¡¨ç¤ºæ©Ÿèƒ½ ---
    socket.on('updateRoomList', (list) => {
        allPublicRooms = list;
        renderRoomList();
    });

    function renderRoomList() {
        const container = document.getElementById('roomListContainer');
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        container.innerHTML = "";

        const filtered = allPublicRooms.filter(r => r.id.toLowerCase().includes(searchTerm));

        if (filtered.length === 0) {
            container.innerHTML = `<p style="text-align:center; color:#a0aec0; font-size:14px; margin-top:20px;">ãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>`;
            return;
        }

        filtered.forEach(room => {
            const div = document.createElement('div');
            div.className = "room-item";
            const passLabel = room.hasPassword ? "ğŸ”’ ãƒ‘ã‚¹ã‚ã‚Š" : "ğŸ”“ å…¬é–‹";
            const timeLabel = room.timeLimit === 'free' ? "ç„¡åˆ¶é™" : `${room.timeLimit}ç§’`;
            
            div.innerHTML = `
                <div class="room-info">
                    <div class="room-name">${room.id}</div>
                    <div class="room-meta">${room.status} | ${room.playerCount}/2äºº | ${timeLabel} | ${passLabel}</div>
                </div>
                <button class="join-btn" ${room.playerCount >= 2 ? 'disabled' : ''} 
                        onclick="handleJoinRoom('${room.id}', ${room.hasPassword})">å‚åŠ </button>
            `;
            container.appendChild(div);
        });
    }

    // --- 2. æ¥ç¶šãƒ»ãƒ«ãƒ¼ãƒ ç®¡ç† ---
    function handleCreateRoom() {
        const name = document.getElementById('createRoomName').value;
        const pass = document.getElementById('createRoomPass').value;
        const time = document.getElementById('createTimeLimit').value;
        if (!name) return alert("ãƒ«ãƒ¼ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        
        socket.emit('createRoom', { roomId: name, password: pass, settings: { timeLimit: time } });
    }

    function handleJoinRoom(roomId, hasPass) {
        let pass = "";
        if (hasPass) {
            pass = prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            if (pass === null) return;
        }
        socket.emit('joinRoom', { roomId, password: pass });
    }

    socket.on('roomJoined', (data) => {
        currentRoomId = data.roomId;
        myPlayerIndex = data.playerIndex;
        document.getElementById('lobbyScreen').style.display = 'none';
        document.getElementById('gameScreen').style.display = 'flex';
        document.getElementById('uiRoomName').textContent = currentRoomId;
        
        handleResize();
        focusOn(64, 64);
    });

    socket.on('gameStart', () => {
        isGameActive = true;
        updateUI();
        draw();
    });

    socket.on('error_msg', m => alert(m));

    // --- 3. ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤å‡¦ç† ---
    socket.on('moveMade', (data) => {
        const p = data.piece;
        gamePieces.push(p);
        gameHistory.push({...p});
        currentTurn = data.nextTurn;
        pairsCount = data.consecutivePairs;

        // ç›¸æ‰‹ãŒæ‰“ã£ãŸãªã‚‰ãã®å ´æ‰€ã«ã‚«ãƒ¡ãƒ©ã‚’ç§»å‹•
        if (p.player !== myPlayerIndex) {
            focusOn(p.x, p.y);
        }

        updateUI();
        draw();
    });

    socket.on('timerUpdate', t => {
        document.getElementById('uiTimer').textContent = t + "s";
    });

    socket.on('gameOver', (data) => {
        isGameActive = false;
        const overlay = document.getElementById('endModal');
        const title = document.getElementById('modalTitle');
        const desc = document.getElementById('modalDescription');

        if (data.winner === -1) {
            title.textContent = "å¼•ãåˆ†ã‘";
            desc.textContent = "ç›¤é¢ãŒã„ã£ã±ã„ã§ã™ã€‚";
        } else {
            const win = data.winner === myPlayerIndex;
            title.textContent = win ? "å‹åˆ©ï¼" : "æ•—åŒ—...";
            desc.textContent = data.reason === "timeout" ? "æ™‚é–“åˆ‡ã‚Œã«ã‚ˆã‚‹æ±ºç€ã§ã™ã€‚" : "äº”ç›®ä¸¦ã³ãŒæˆç«‹ã—ã¾ã—ãŸã€‚";
        }
        overlay.classList.add('active');
    });

    socket.on('playerLeft', () => {
        alert("å¯¾æˆ¦ç›¸æ‰‹ãŒé€€å‡ºã—ã¾ã—ãŸã€‚ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚Šã¾ã™ã€‚");
        location.reload();
    });

    // --- 4. ç›¤é¢æç”»ãƒ»ã‚«ãƒ¡ãƒ© ---
    function focusOn(gx, gy) {
        vX = gx; vY = gy;
    }

    function draw() {
        if (!canvas.width) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const currentCellSize = CELL_SIZE * zoom;
        const ox = canvas.width / 2 - vX * currentCellSize;
        const oy = canvas.height / 2 - vY * currentCellSize;

        // 128x128 ç›¤é¢ã®èƒŒæ™¯
        ctx.fillStyle = "#164e63"; // æ·±ç·‘/é’
        ctx.fillRect(ox, oy, GRID_SIZE * currentCellSize, GRID_SIZE * currentCellSize);

        // ã‚°ãƒªãƒƒãƒ‰ç·š
        ctx.strokeStyle = "rgba(255,255,255,0.08)";
        ctx.lineWidth = 1;
        ctx.beginPath();
        for (let i = 0; i <= GRID_SIZE; i++) {
            ctx.moveTo(ox + i * currentCellSize, oy);
            ctx.lineTo(ox + i * currentCellSize, oy + GRID_SIZE * currentCellSize);
            ctx.moveTo(ox, oy + i * currentCellSize);
            ctx.lineTo(ox + GRID_SIZE * currentCellSize, oy + i * currentCellSize);
        }
        ctx.stroke();

        // é§’æç”»
        const list = isReviewing ? gameHistory.slice(0, reviewPointer) : gamePieces;

        list.forEach((p) => {
            const px = ox + p.x * currentCellSize + currentCellSize / 2;
            const py = oy + p.y * currentCellSize + currentCellSize / 2;

            if (px < -currentCellSize || px > canvas.width + currentCellSize) return;

            // ãƒ©ãƒ³ãƒ‰ãƒ«ãƒˆç’°ã®å††
            ctx.beginPath();
            ctx.arc(px, py, currentCellSize * 0.35, 0, Math.PI * 2);
            ctx.strokeStyle = (p.player === 0) ? "#000000" : "#ffffff";
            ctx.lineWidth = currentCellSize * 0.12;
            ctx.stroke();

            // åˆ‡ã‚Œç›®ï¼ˆé»„ï¼‰
            ctx.beginPath();
            const angles = [-Math.PI/2, 0, Math.PI/2, Math.PI];
            const sA = angles[p.direction] - 0.4;
            const eA = angles[p.direction] + 0.4;
            ctx.arc(px, py, currentCellSize * 0.35, sA, eA);
            ctx.strokeStyle = "#facc15";
            ctx.lineWidth = currentCellSize * 0.14;
            ctx.stroke();
        });
    }

    // --- 5. ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ ---
    function changeDirection(d) {
        selectedDir = d;
        document.querySelectorAll('.dir-btn').forEach((b, i) => b.classList.toggle('active', i === d));
    }

    function handleCanvasClick(screenX, screenY) {
        if (!isGameActive || currentTurn !== myPlayerIndex || isReviewing) return;

        const currentCellSize = CELL_SIZE * zoom;
        const ox = canvas.width / 2 - vX * currentCellSize;
        const oy = canvas.height / 2 - vY * currentCellSize;

        const gx = Math.floor((screenX - ox) / currentCellSize);
        const gy = Math.floor((screenY - oy) / currentCellSize);

        if (gx < 0 || gx >= GRID_SIZE || gy < 0 || gy >= GRID_SIZE) return;
        if (gamePieces.find(p => p.x === gx && p.y === gy)) return;

        // ã€Œå¯¾ã€ã®åˆ¤å®š
        let isPair = false;
        const lastOpp = gamePieces.filter(p => p.player !== myPlayerIndex).slice(-1)[0];
        if (lastOpp) {
            const dx = gx - lastOpp.x;
            const dy = gy - lastOpp.y;
            if ((lastOpp.direction === 0 && dx === 0 && dy === -1) ||
                (lastOpp.direction === 1 && dx === 1 && dy === 0) ||
                (lastOpp.direction === 2 && dx === 0 && dy === 1) ||
                (lastOpp.direction === 3 && dx === -1 && dy === 0)) {
                isPair = true;
            }
        }

        if (isPair && pairsCount[myPlayerIndex] >= 3) {
            alert("ã€Œå¯¾ã€ã¯3å›é€£ç¶šã¾ã§ã§ã™ã€‚æ¬¡ã¯åˆ¥ã®å ´æ‰€ã«æ‰“ã¡ã¾ã—ã‚‡ã†ã€‚");
            return;
        }

        // é€ä¿¡ç›´å‰ã«ã‚¿ãƒ¼ãƒ³ã‚’ãƒ­ãƒƒã‚¯
        const oldTurn = currentTurn;
        currentTurn = -1;

        const newPiece = { x: gx, y: gy, direction: selectedDir, player: myPlayerIndex };
        const newPairs = [...pairsCount];
        newPairs[myPlayerIndex] = isPair ? newPairs[myPlayerIndex] + 1 : 0;

        socket.emit('placePiece', { roomId: currentRoomId, piece: newPiece, consecutivePairs: newPairs });

        // å‹æ•—åˆ¤å®š
        if (checkVictory(gamePieces.concat(newPiece), myPlayerIndex)) {
            socket.emit('declareWin', { roomId: currentRoomId, winner: myPlayerIndex });
        }
    }

    function checkVictory(all, pIdx) {
        const my = all.filter(p => p.player === pIdx);
        const axes = [[1, 0], [0, 1], [1, 1], [1, -1]];
        
        for (let p of my) {
            for (let [dx, dy] of axes) {
                let line = [p];
                for (let i = 1; i < 5; i++) {
                    const f = my.find(v => v.x === p.x + dx * i && v.y === p.y + dy * i);
                    if (f) line.push(f); else break;
                }
                if (line.length >= 5) {
                    // ãã®ä¸­ã«å‘ãåˆã£ã¦ã„ã‚‹ãƒšã‚¢ãŒã‚ã‚‹ã‹
                    for (let a of line) {
                        for (let b of my) {
                            if (a === b) continue;
                            const ddx = b.x - a.x, ddy = b.y - a.y;
                            if (Math.abs(ddx) > 1 || Math.abs(ddy) > 1) continue;
                            if (ddx === 0 && ddy === -1 && a.direction === 0 && b.direction === 2) return true;
                            if (ddx === 1 && ddy === 0 && a.direction === 1 && b.direction === 3) return true;
                            if (ddx === 0 && ddy === 1 && a.direction === 2 && b.direction === 0) return true;
                            if (ddx === -1 && ddy === 0 && a.direction === 3 && b.direction === 1) return true;
                        }
                    }
                }
            }
        }
        return false;
    }

    // --- 6. æ„Ÿæƒ³æˆ¦ãƒ¢ãƒ¼ãƒ‰ ---
    function startReviewMode() {
        document.getElementById('endModal').classList.remove('active');
        isReviewing = true;
        reviewPointer = gameHistory.length;
        document.getElementById('reviewPanel').style.display = 'block';
        document.getElementById('dirBtns').style.display = 'none';
        updateReviewUI();
        draw();
    }

    function navigateReview(dir) {
        reviewPointer = Math.max(0, Math.min(gameHistory.length, reviewPointer + dir));
        if (reviewPointer > 0) {
            const p = gameHistory[reviewPointer - 1];
            focusOn(p.x, p.y);
        }
        updateReviewUI();
        draw();
    }

    function updateReviewUI() {
        document.getElementById('reviewStepLabel').textContent = `${reviewPointer} / ${gameHistory.length}`;
    }

    // --- 7. ãã®ä»–UI/ã‚¤ãƒ™ãƒ³ãƒˆ ---
    function updateUI() {
        const statusLabel = document.getElementById('uiGameStatus');
        if (!isGameActive) {
            statusLabel.textContent = "ç›¸æ‰‹ã‚’å¾…ã£ã¦ã„ã¾ã™...";
            return;
        }
        const color = currentTurn === 0 ? "é»’" : "ç™½";
        if (currentTurn === myPlayerIndex) {
            statusLabel.textContent = `â˜… ã‚ãªãŸã®ç•ª (${color})`;
            statusLabel.style.color = "#3182ce";
        } else {
            statusLabel.textContent = `ç›¸æ‰‹ã®ç•ª (${color})`;
            statusLabel.style.color = "#718096";
        }
        document.getElementById('uiPairInfo').textContent = `é€£ç¶šå¯¾: é»’${pairsCount[0]}/3 ç™½${pairsCount[1]}/3`;
    }

    function handleResize() {
        const container = document.getElementById('canvasContainer');
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        draw();
    }
    window.addEventListener('resize', handleResize);

    // æ“ä½œç³»ï¼ˆãƒã‚¦ã‚¹ãƒ»ã‚¿ãƒƒãƒï¼‰
    let isMoving = false, lastX, lastY;

    canvas.addEventListener('mousedown', (e) => {
        if (e.button !== 0) { isMoving = true; lastX = e.clientX; lastY = e.clientY; }
    });
    window.addEventListener('mousemove', (e) => {
        if (isMoving) {
            const cellSize = CELL_SIZE * zoom;
            vX -= (e.clientX - lastX) / cellSize;
            vY -= (e.clientY - lastY) / cellSize;
            lastX = e.clientX; lastY = e.clientY;
            draw();
        }
    });
    window.addEventListener('mouseup', () => isMoving = false);
    canvas.addEventListener('click', (e) => {
        if (!isMoving) {
            const rect = canvas.getBoundingClientRect();
            handleCanvasClick(e.clientX - rect.left, e.clientY - rect.top);
        }
    });

    // ã‚ºãƒ¼ãƒ ï¼ˆãƒ›ã‚¤ãƒ¼ãƒ«ï¼‰
    canvas.addEventListener('wheel', (e) => {
        e.preventDefault();
        zoom = Math.max(0.5, Math.min(zoom * (e.deltaY > 0 ? 0.9 : 1.1), 3.0));
        draw();
    }, { passive: false });

</script>
</body>
</html>



