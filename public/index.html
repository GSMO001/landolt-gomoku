<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒ©ãƒ³ãƒ‰ãƒ«ãƒˆç’°äº”ç›®ä¸¦ã¹ ONLINE</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: none; }
        body { font-family: sans-serif; background: #f1f5f9; height: 100vh; overflow: hidden; display: flex; justify-content: center; }
        .container { background: white; width: 100vw; max-width: 500px; height: 100vh; display: flex; flex-direction: column; position: relative; }

        /* ãƒ­ãƒ“ãƒ¼ */
        #lobbyScreen { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        .section-title { font-size: 16px; font-weight: bold; margin: 15px 0 10px; color: #1e293b; }
        .input-group { background: #fff; border: 1px solid #e2e8f0; padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        input, select { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 15px; }
        .btn { padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; }
        
        /* æ¤œç´¢ãƒãƒ¼ */
        .search-bar { position: sticky; top: 0; background: #f1f5f9; padding: 10px 0; z-index: 10; }
        #roomSearchInput { background: white; }

        /* ãƒ«ãƒ¼ãƒ ã‚¢ã‚¤ãƒ†ãƒ  */
        .room-item { background: white; border: 1px solid #e2e8f0; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .room-item:hover { border-color: #3b82f6; }
        .room-info b { font-size: 15px; }
        .room-info p { font-size: 12px; color: #64748b; }
        .join-btn { width: auto; padding: 6px 15px; font-size: 14px; }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ */
        #gameScreen { display: none; flex: 1; flex-direction: column; }
        .game-header { padding: 10px 15px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        #canvasArea { flex: 1; background: #14532d; position: relative; }
        canvas { display: block; width: 100%; height: 100%; }

        .game-footer { padding: 15px; background: #fff; border-top: 1px solid #ddd; }
        .dir-btns { display: flex; justify-content: center; gap: 8px; margin-bottom: 15px; }
        .dir-btn { width: 45px; height: 45px; border: 2px solid #cbd5e1; background: #fff; border-radius: 8px; font-size: 18px; font-weight: bold; }
        .dir-btn.active { border-color: #3b82f6; color: #3b82f6; background: #eff6ff; }

        /* æ„Ÿæƒ³æˆ¦ */
        #reviewUI { display: none; border-top: 2px dashed #e2e8f0; padding-top: 15px; text-align: center; }
        .rev-ctrl { padding: 8px 15px; background: #475569; color: #fff; border: none; border-radius: 6px; margin: 0 5px; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 100; justify-content: center; align-items: center; }
        .modal.show { display: flex; }
        .modal-content { background: #fff; padding: 25px; border-radius: 15px; width: 85%; max-width: 320px; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <div id="lobbyScreen">
        <h2 style="text-align:center; margin: 10px 0;">ãƒ©ãƒ³ãƒ‰ãƒ«ãƒˆç’°äº”ç›®ä¸¦ã¹</h2>
        
        <div class="input-group">
            <div class="section-title" style="margin-top:0;">æ–°ã—ã„å¯¾å±€ã‚’ä½œæˆ</div>
            <input type="text" id="createRoomId" placeholder="ãƒ«ãƒ¼ãƒ å">
            <input type="password" id="createPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰(ä»»æ„)">
            <select id="createTime">
                <option value="30">30ç§’</option>
                <option value="60">60ç§’</option>
                <option value="free">ç„¡åˆ¶é™</option>
            </select>
            <button class="btn" onclick="doCreate()">ä½œæˆ</button>
        </div>

        <div class="search-bar">
            <input type="text" id="roomSearchInput" placeholder="ğŸ” ãƒ«ãƒ¼ãƒ åã‚’æ¤œç´¢..." oninput="filterRooms()">
        </div>

        <div class="section-title">é€²è¡Œä¸­ã®ãƒ«ãƒ¼ãƒ </div>
        <div id="roomList"></div>
    </div>

    <div id="gameScreen">
        <div class="game-header">
            <div><b id="roomTitle">Room</b><br><small id="statusMsg">å¾…æ©Ÿä¸­...</small></div>
            <div id="timer" style="font-size:22px; font-weight:bold; color:#e11d48;">--</div>
        </div>
        <div id="canvasArea"><canvas id="gameCanvas"></canvas></div>
        <div class="game-footer">
            <div class="dir-btns" id="dirBtns">
                <button class="dir-btn active" onclick="setDir(0)">â†‘</button>
                <button class="dir-btn" onclick="setDir(1)">â†’</button>
                <button class="dir-btn" onclick="setDir(2)">â†“</button>
                <button class="dir-btn" onclick="setDir(3)">â†</button>
            </div>
            <div id="reviewUI">
                <p style="margin-bottom:8px; font-size:14px; font-weight:bold;">æ„Ÿæƒ³æˆ¦ãƒ¢ãƒ¼ãƒ‰</p>
                <button class="rev-ctrl" onclick="moveReview(-1)">â—€ å‰</button>
                <span id="revCounter" style="font-weight:bold; margin:0 10px;">0 / 0</span>
                <button class="rev-ctrl" onclick="moveReview(1)">æ¬¡ â–¶</button>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span id="pairInfo" style="font-size:12px; color:#64748b;">é€£ç¶šå¯¾: 0/0</span>
                <button onclick="location.reload()" style="color:#ef4444; border:none; background:none; font-weight:bold; cursor:pointer;">é€€å‡º</button>
            </div>
        </div>
    </div>
</div>

<div id="msgModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">å¯¾å±€çµ‚äº†</h3>
        <p id="modalBody" style="margin: 15px 0; color: #475569;"></p>
        <button class="btn" onclick="startReview()">æ„Ÿæƒ³æˆ¦ã‚’é–‹å§‹</button>
        <button class="btn" style="background:#94a3b8; margin-top:8px;" onclick="location.reload()">ãƒ­ãƒ“ãƒ¼ã¸</button>
    </div>
</div>

<script>
    const socket = io();
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    let currentRooms = []; // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å—ä¿¡ã—ãŸå…¨ãƒ«ãƒ¼ãƒ 
    let myId = "", myIdx = null, pieces = [], history = [], turn = 0, pairs = [0,0];
    let vX = 64, vY = 64, zoom = 1.0, selDir = 0, isRev = false, revPtr = 0, active = false;

    // --- ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆæ›´æ–°ãƒ»æ¤œç´¢ ---
    socket.on('updateRoomList', (list) => {
        currentRooms = list;
        filterRooms(); // ãƒªã‚¹ãƒˆå—ä¿¡æ™‚ã«ç¾åœ¨ã®æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    });

    function filterRooms() {
        const query = document.getElementById('roomSearchInput').value.toLowerCase();
        const container = document.getElementById('roomList');
        container.innerHTML = "";
        
        const filtered = currentRooms.filter(r => r.id.toLowerCase().includes(query));
        
        if(filtered.length === 0) {
            container.innerHTML = "<p style='color:#94a3b8; font-size:14px; text-align:center;'>ãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>";
            return;
        }

        filtered.forEach(r => {
            const div = document.createElement('div');
            div.className = "room-item";
            div.innerHTML = `
                <div class="room-info">
                    <b>${r.id} ${r.hasPassword ? 'ğŸ”’' : ''}</b>
                    <p>${r.status} (${r.playerCount}/2äºº)</p>
                </div>
                <button class="btn join-btn" ${r.playerCount >= 2 ? 'disabled' : ''}>å‚åŠ </button>
            `;
            div.onclick = () => r.playerCount < 2 && doJoin(r.id, r.hasPassword);
            container.appendChild(div);
        });
    }

    // --- é€šä¿¡ãƒ­ã‚¸ãƒƒã‚¯ ---
    function doCreate() {
        const id = document.getElementById('createRoomId').value;
        if(!id) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        socket.emit('createRoom', {
            roomId: id,
            password: document.getElementById('createPassword').value,
            settings: { timeLimit: document.getElementById('createTime').value }
        });
    }

    function doJoin(id, hasPass) {
        let pass = hasPass ? prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„") : "";
        if(pass !== null) socket.emit('joinRoom', { roomId: id, password: pass });
    }

    socket.on('roomJoined', (data) => {
        myId = data.roomId; myIdx = data.playerIndex;
        document.getElementById('lobbyScreen').style.display = 'none';
        document.getElementById('gameScreen').style.display = 'flex';
        document.getElementById('roomTitle').textContent = myId;
        resize(); center(64,64);
    });

    socket.on('gameStart', () => { active = true; updateUI(); render(); });

    socket.on('moveMade', (data) => {
        pieces.push(data.piece);
        history.push({...data.piece});
        turn = data.nextTurn;
        pairs = data.consecutivePairs;
        if(data.piece.player !== myIdx) center(data.piece.x, data.piece.y);
        updateUI(); render();
    });

    socket.on('timerUpdate', (t) => document.getElementById('timer').textContent = t + "s");

    socket.on('gameOver', (d) => {
        active = false;
        document.getElementById('modalTitle').textContent = d.winner === myIdx ? "å‹åˆ©ï¼" : (d.winner === -1 ? "å¼•ãåˆ†ã‘" : "æ•—åŒ—...");
        document.getElementById('modalBody').textContent = d.reason === "timeout" ? "æ™‚é–“åˆ‡ã‚Œã§ã™" : "äº”ç›®ä¸¦ã³ãŒæˆç«‹ã—ã¾ã—ãŸ";
        document.getElementById('msgModal').classList.add('show');
    });

    socket.on('error_msg', m => alert(m));
    socket.on('playerLeft', () => { alert("ç›¸æ‰‹ãŒé€€å‡ºã—ã¾ã—ãŸ"); location.reload(); });

    // --- æç”»ç³» ---
    function center(x, y) { vX = x; vY = y; }
    function render() {
        if(!canvas.width) return;
        const sz = 40 * zoom;
        const ox = canvas.width/2 - vX * sz, oy = canvas.height/2 - vY * sz;
        
        ctx.fillStyle = "#166534"; ctx.fillRect(0,0,canvas.width,canvas.height); // èƒŒæ™¯
        ctx.fillStyle = "#14532d"; ctx.fillRect(ox, oy, 128*sz, 128*sz); // ç›¤

        ctx.strokeStyle = "rgba(255,255,255,0.1)"; ctx.beginPath();
        for(let i=0; i<=128; i++) {
            ctx.moveTo(ox+i*sz, oy); ctx.lineTo(ox+i*sz, oy+128*sz);
            ctx.moveTo(ox, oy+i*sz); ctx.lineTo(ox+128*sz, oy+i*sz);
        }
        ctx.stroke();

        const list = isRev ? history.slice(0, revPtr) : pieces;
        list.forEach((p, idx) => {
            const px = ox + p.x*sz + sz/2, py = oy + p.y*sz + sz/2;
            if(px < -sz || px > canvas.width+sz || py < -sz || py > canvas.height+sz) return;
            
            ctx.beginPath(); ctx.arc(px, py, sz*0.35, 0, Math.PI*2);
            ctx.strokeStyle = p.player===0 ? "#000" : "#fff";
            ctx.lineWidth = sz*0.12; ctx.stroke();

            ctx.beginPath();
            const am = [-Math.PI/2, 0, Math.PI/2, Math.PI];
            ctx.arc(px, py, sz*0.35, am[p.direction]-0.4, am[p.direction]+0.4);
            ctx.strokeStyle = "#fbbf24"; ctx.lineWidth = sz*0.14; ctx.stroke();
        });
    }

    // --- ã‚²ãƒ¼ãƒ æ“ä½œ ---
    function setDir(d) {
        selDir = d;
        document.querySelectorAll('.dir-btn').forEach((b,i) => b.classList.toggle('active', i===d));
    }

    function updateUI() {
        const msg = document.getElementById('statusMsg');
        if(!active) return msg.textContent = "ç›¸æ‰‹ã®å…¥å®¤ã‚’å¾…æ©Ÿä¸­...";
        msg.textContent = turn === myIdx ? `â˜… ã‚ãªãŸã®ç•ª (${turn===0?'é»’':'ç™½'})` : `ç›¸æ‰‹ã®ç•ª (${turn===0?'é»’':'ç™½'})`;
        document.getElementById('pairInfo').textContent = `é€£ç¶šå¯¾: é»’${pairs[0]}/3 ç™½${pairs[1]}/3`;
    }

    canvas.onclick = (e) => {
        if(!active || turn !== myIdx || isRev) return;
        const r = canvas.getBoundingClientRect();
        const sz = 40 * zoom;
        const ox = canvas.width/2 - vX * sz, oy = canvas.height/2 - vY * sz;
        const gx = Math.floor((e.clientX - r.left - ox) / sz);
        const gy = Math.floor((e.clientY - r.top - oy) / sz);

        if(gx<0 || gx>=128 || gy<0 || gy>=128 || pieces.find(p=>p.x===gx && p.y===gy)) return;

        let isP = false;
        const last = pieces.filter(p=>p.player!==myIdx).slice(-1)[0];
        if(last) {
            const dx=gx-last.x, dy=gy-last.y;
            if((last.direction===0&&dy===-1) || (last.direction===1&&dx===1) || (last.direction===2&&dy===1) || (last.direction===3&&dx===-1)) isP = true;
        }
        if(isP && pairs[myIdx] >= 3) return alert("4å›é€£ç¶šã®å¯¾ã¯ç¦æ­¢ã§ã™");

        turn = -1; // é€£æ‰“é˜²æ­¢
        const p = { x:gx, y:gy, direction:selDir, player:myIdx };
        const np = [...pairs]; np[myIdx] = isP ? np[myIdx]+1 : 0;

        socket.emit('placePiece', { roomId: myId, piece: p, consecutivePairs: np });
        if(checkWin(pieces.concat(p), myIdx)) socket.emit('declareWin', { roomId: myId, winner: myIdx });
    };

    function checkWin(pts, idx) {
        const my = pts.filter(p=>p.player===idx);
        const ds = [[1,0],[0,1],[1,1],[1,-1]];
        for(let p of my) {
            for(let [dx,dy] of ds) {
                let line = [p];
                for(let i=1; i<5; i++) {
                    const f = my.find(t=>t.x===p.x+dx*i && t.y===p.y+dy*i);
                    if(f) line.push(f); else break;
                }
                if(line.length >= 5) {
                    for(let la of line) for(let lb of my) {
                        const ddx=lb.x-la.x, ddy=lb.y-la.y;
                        if(Math.abs(ddx)<=1 && Math.abs(ddy)<=1) {
                            if(ddx===0 && ddy===-1 && la.direction===0 && lb.direction===2) return true;
                            if(ddx===1 && ddy===0 && la.direction===1 && lb.direction===3) return true;
                            if(ddx===0 && ddy===1 && la.direction===2 && lb.direction===0) return true;
                            if(ddx===-1 && ddy===0 && la.direction===3 && lb.direction===1) return true;
                        }
                    }
                }
            }
        }
        return false;
    }

    // --- æ„Ÿæƒ³æˆ¦ ---
    function startReview() {
        document.getElementById('msgModal').classList.remove('show');
        isRev = true; revPtr = history.length;
        document.getElementById('reviewUI').style.display = 'block';
        document.getElementById('dirBtns').style.display = 'none';
        updateRevUI(); render();
    }
    function moveReview(d) {
        revPtr = Math.max(0, Math.min(history.length, revPtr + d));
        if(revPtr > 0) center(history[revPtr-1].x, history[revPtr-1].y);
        updateRevUI(); render();
    }
    function updateRevUI() { document.getElementById('revCounter').textContent = `${revPtr} / ${history.length}`; }

    // --- ã‚«ãƒ¡ãƒ©ãƒ»ã‚ºãƒ¼ãƒ  ---
    let isDrag = false, lX, lY;
    canvas.onmousedown = (e) => { if(e.button !== 0) { isDrag = true; lX = e.clientX; lY = e.clientY; } };
    window.onmousemove = (e) => { if(isDrag) { const sz=40*zoom; vX-=(e.clientX-lX)/sz; vY-=(e.clientY-lY)/sz; lX=e.clientX; lY=e.clientY; render(); } };
    window.onmouseup = () => isDrag = false;
    canvas.onwheel = (e) => { e.preventDefault(); zoom = Math.max(0.5, Math.min(zoom*(e.deltaY>0?0.9:1.1), 3)); render(); };

    function resize() {
        const w = document.getElementById('canvasArea');
        canvas.width = w.clientWidth; canvas.height = w.clientHeight; render();
    }
    window.onresize = resize;
</script>
</body>
</html>


