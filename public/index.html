<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LANDOLT ONLINE - GITHUB EDITION</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --bg: #0f172a; --panel: #ffffff; --green: #14532d; --accent: #2563eb; --red: #dc2626; --gold: #fbbf24; }
        * { margin:0; padding:0; box-sizing:border-box; -webkit-touch-callout:none; user-select:none; touch-action:none; }
        body { font-family:-apple-system, sans-serif; background:var(--bg); height:100vh; display:flex; justify-content:center; overflow:hidden; }
        
        .app { width:100%; max-width:500px; height:100%; background:var(--panel); display:flex; flex-direction:column; position:relative; }

        /* LOBBY: „É´„Éº„É†„É™„Çπ„Éà„ÅÆ„Çπ„ÇØ„É≠„Éº„É´„ÇíÂÆåÂÖ®„Å´‰øùË®º */
        #lobby { flex:1; display:flex; flex-direction:column; padding:20px; overflow:hidden; }
        .hero { text-align:center; font-size:24px; font-weight:900; margin-bottom:15px; }
        
        .create-card { background:#f1f5f9; padding:15px; border-radius:15px; margin-bottom:15px; flex-shrink:0; }
        .input-row { margin-bottom:8px; }
        input, select { width:100%; padding:10px; border-radius:10px; border:2px solid #e2e8f0; font-size:16px; outline:none; }
        
        .search-area { margin-bottom:10px; flex-shrink:0; }
        #room-search { background:#eff6ff; border-color:#bfdbfe; }

        /* „Çπ„ÇØ„É≠„Éº„É´È†òÂüü„ÅÆÂÆöÁæ© */
        .list-container { flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch; padding-right:4px; }
        .list-container::-webkit-scrollbar { width:6px; }
        .list-container::-webkit-scrollbar-thumb { background:#cbd5e1; border-radius:10px; }

        .room-card { background:white; border:2px solid #f1f5f9; border-radius:14px; padding:12px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; }
        .room-info b { font-size:16px; color:#1e293b; }
        .room-info p { font-size:12px; color:#64748b; font-weight:bold; }

        /* GAME UI */
        #game { display:none; flex-direction:column; height:100%; }
        .game-bar { padding:10px 20px; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center; }
        #timer { font-size:28px; font-weight:900; color:var(--red); }

        #stage-container { flex:1; background:var(--green); position:relative; overflow:hidden; }
        canvas { display:block; width:100%; height:100%; }

        /* FOOTER & LEAVE BUTTON: ‰∏ãÁ´Ø„Åã„Çâ45pxÊµÆ„Åã„Åõ„Çã */
        .game-footer { padding:15px 20px 45px 20px; border-top:1px solid #e2e8f0; background:white; }
        .dir-panel { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:15px; }
        .dir-btn { height:50px; border:2px solid #f1f5f9; border-radius:12px; font-size:22px; display:flex; align-items:center; justify-content:center; color:#94a3b8; background:white; }
        .dir-btn.active { border-color:var(--accent); color:var(--accent); background:#eff6ff; }
        
        .leave-btn { width:100%; padding:10px; font-size:24px; font-weight:900; color:var(--red); border:none; background:none; cursor:pointer; }
        
        /* Modal */
        .overlay { display:none; position:absolute; inset:0; background:rgba(0,0,0,0.85); z-index:1000; align-items:center; justify-content:center; padding:40px; }
        .modal { background:white; width:100%; border-radius:24px; padding:30px; text-align:center; }
    </style>
</head>
<body>

<div class="app">
    <div id="lobby">
        <div class="hero">LANDOLT ONLINE</div>
        <div class="create-card">
            <div class="input-row"><input type="text" id="c-id" placeholder="„É´„Éº„É†Âêç„ÇíÂÖ•Âäõ"></div>
            <div class="input-row"><input type="password" id="c-pw" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ(‰ªªÊÑè)"></div>
            <div class="input-row">
                <select id="c-limit">
                    <option value="30">30Áßí</option>
                    <option value="60" selected>60Áßí</option>
                    <option value="free">Âà∂Èôê„Å™„Åó</option>
                </select>
            </div>
            <button onclick="reqCreate()" style="width:100%; padding:12px; background:var(--accent); color:white; border:none; border-radius:10px; font-weight:bold;">Êñ∞Ë¶è„É´„Éº„É†‰ΩúÊàê</button>
        </div>

        <div class="search-area">
            <input type="text" id="room-search" placeholder="üîç „É´„Éº„É†„ÇíÊ§úÁ¥¢..." oninput="updateListView()">
        </div>

        <div class="list-container" id="list-target">
            </div>
    </div>

    <div id="game">
        <div class="game-bar">
            <div><b id="ui-room">---</b><br><span id="ui-turn" style="font-size:12px; font-weight:bold;">CONNECTING...</span></div>
            <div id="timer">--</div>
        </div>
        <div id="stage-container"><canvas id="stage"></canvas></div>
        <div class="game-footer">
            <div class="dir-panel">
                <div class="dir-btn active" id="db0" onclick="setDir(0)">‚Üë</div>
                <div class="dir-btn" id="db1" onclick="setDir(1)">‚Üí</div>
                <div class="dir-btn" id="db2" onclick="setDir(2)">‚Üì</div>
                <div class="dir-btn" id="db3" onclick="setDir(3)">‚Üê</div>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <span id="ui-pairs" style="font-weight:900; color:#475569;">PAIRS: B 0 / W 0</span>
            </div>
            <button class="leave-btn" onclick="location.reload()">LEAVE GAME</button>
        </div>
    </div>

    <div id="modal-end" class="overlay">
        <div class="modal">
            <h2 id="end-title" style="font-size:30px; margin-bottom:10px;">END</h2>
            <p id="end-desc" style="color:#64748b; font-weight:bold; margin-bottom:25px;"></p>
            <button onclick="location.reload()" style="width:100%; padding:12px; background:var(--accent); color:white; border:none; border-radius:10px; font-weight:bold;">Êàª„Çã</button>
        </div>
    </div>
</div>

<script>
    const socket = io();
    const cvs = document.getElementById('stage');
    const ctx = cvs.getContext('2d', { alpha: false });
    const container = document.getElementById('stage-container');
    
    let g_rooms = [], g_side = null, g_turn = 0, g_board = [], g_pairs = [0,0], g_active = false;
    let cam = { x:64, y:64, zoom:1.0 }, selDir = 0, touches = new Map(), isDrag = false;

    // --- Lobby: ÂÖ®„É´„Éº„É†„ÅÆÂêåÊúü„Å®„Çπ„ÇØ„É≠„Éº„É´ÊèèÁîª ---
    socket.on('updateRoomList', list => { g_rooms = list; updateListView(); });
    
    function updateListView() {
        const target = document.getElementById('list-target');
        const q = document.getElementById('room-search').value.toLowerCase();
        target.innerHTML = "";
        const filtered = g_rooms.filter(r => r.id.toLowerCase().includes(q));
        if(!filtered.length) { target.innerHTML = "<p style='text-align:center; padding:20px; color:#94a3b8;'>„É´„Éº„É†„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>"; return; }
        
        filtered.forEach(r => {
            const div = document.createElement('div');
            div.className = 'room-card';
            div.innerHTML = `
                <div class="room-info"><b>${r.id} ${r.hasPw?'üîí':''}</b><p>${r.status} (${r.playerCount}/2) | ${r.timeLimit}s</p></div>
                <button onclick="reqJoin('${r.id}', ${r.hasPw})" 
                    style="padding:8px 15px; background:var(--green); color:white; border:none; border-radius:8px; font-weight:bold;"
                    ${r.playerCount>=2?'disabled':''}>ÂèÇÂä†</button>
            `;
            target.appendChild(div);
        });
    }

    function reqCreate() {
        const id = document.getElementById('c-id').value;
        const pw = document.getElementById('c-pw').value;
        const lim = document.getElementById('c-limit').value;
        if(!id) return alert("ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
        socket.emit('createRoom', { roomId:id, password:pw, settings:{timeLimit:lim} });
    }
    function reqJoin(id, hp) { const pw = hp ? prompt("PW:") : ""; if(pw!==null) socket.emit('joinRoom', { roomId:id, password:pw }); }

    // --- Game Engine ---
    socket.on('roomJoined', data => {
        g_side = data.playerIndex;
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('game').style.display = 'flex';
        document.getElementById('ui-room').textContent = data.roomId;
        resize();
    });
    socket.on('gameStart', () => { g_active = true; uiSync(); render(); });
    socket.on('moveMade', data => {
        g_board.push(data.piece); g_turn = data.nextTurn; g_pairs = data.consecutivePairs;
        if(data.piece.player !== g_side) { cam.x = data.piece.x; cam.y = data.piece.y; }
        uiSync(); render();
    });
    socket.on('timerUpdate', t => document.getElementById('timer').textContent = t+"s");
    socket.on('gameOver', data => {
        g_active = false;
        document.getElementById('modal-end').style.display = 'flex';
        document.getElementById('end-title').textContent = (data.winner === g_side) ? "ÂãùÂà©" : "ÊïóÂåó";
        document.getElementById('end-desc').textContent = (data.reason === "timeout") ? "ÊôÇÈñìÂàá„Çå„Åß„Åô" : "‰∫îÁõÆÔºàÂØæËæº„ÅøÔºâÈÅîÊàêÔºÅ";
    });
    socket.on('playerLeft', () => { alert("Áõ∏Êâã„ÅåÈÄÄÂá∫„Åó„Åæ„Åó„Åü"); location.reload(); });
    socket.on('error_msg', m => alert(m));

    function render() {
        if(!cvs.width) return;
        ctx.fillStyle = "#020617"; ctx.fillRect(0,0,cvs.width,cvs.height);
        const s = 45 * cam.zoom;
        const ox = cvs.width/2 - cam.x*s, oy = cvs.height/2 - cam.y*s;
        
        ctx.fillStyle = "#14532d"; ctx.fillRect(ox, oy, 128*s, 128*s);
        ctx.strokeStyle = "rgba(255,255,255,0.1)"; ctx.lineWidth=1;
        ctx.beginPath();
        for(let i=0;i<=128;i++){
            ctx.moveTo(ox+i*s, oy); ctx.lineTo(ox+i*s, oy+128*s);
            ctx.moveTo(ox, oy+i*s); ctx.lineTo(ox+128*s, oy+i*s);
        }
        ctx.stroke();

        // Á∑ö„ÅÆÊèèÁîªÔºàÂØæ„ÅÆÂà§ÂÆöÔºâ
        ctx.save(); ctx.setLineDash([4,4]); ctx.strokeStyle="#ef4444"; ctx.lineWidth=2;
        g_board.forEach((p,i)=>{
            for(let j=i+1;j<g_board.length;j++){
                const q = g_board[j];
                if(p.player === q.player && checkFace(p,q)){
                    ctx.beginPath(); ctx.moveTo(ox+p.x*s+s/2, oy+p.y*s+s/2); ctx.lineTo(ox+q.x*s+s/2, oy+q.y*s+s/2); ctx.stroke();
                }
            }
        });
        ctx.restore();

        // Èßí„ÅÆÊèèÁîª
        g_board.forEach(p => {
            const px = ox+p.x*s+s/2, py = oy+p.y*s+s/2;
            ctx.beginPath(); ctx.arc(px, py, s*0.35, 0, Math.PI*2);
            ctx.strokeStyle = p.player===0?"#000":"#fff"; ctx.lineWidth=s*0.12; ctx.stroke();
            ctx.beginPath(); const a = [-Math.PI/2, 0, Math.PI/2, Math.PI][p.direction];
            ctx.arc(px, py, s*0.35, a-0.45, a+0.45); ctx.strokeStyle="#fbbf24"; ctx.lineWidth=s*0.15; ctx.stroke();
        });
    }

    function checkFace(a,b){
        const dx = b.x-a.x, dy = b.y-a.y;
        if(Math.abs(dx)>1||Math.abs(dy)>1) return false;
        if(dx===0&&dy===-1) return a.direction===0&&b.direction===2;
        if(dx===1&&dy===0) return a.direction===1&&b.direction===3;
        if(dx===0&&dy===1) return a.direction===2&&b.direction===0;
        if(dx===-1&&dy===0) return a.direction===3&&b.direction===1;
        return false;
    }

    // --- Input Control ---
    container.addEventListener('touchstart', e => {
        e.preventDefault(); isDrag = false;
        for(let t of e.changedTouches) touches.set(t.identifier, {x:t.clientX, y:t.clientY});
    }, {passive:false});

    container.addEventListener('touchmove', e => {
        e.preventDefault();
        if(e.touches.length===1){
            const t = e.touches[0], last = touches.get(t.identifier);
            if(last){
                const dx = t.clientX-last.x, dy = t.clientY-last.y;
                if(Math.abs(dx)>5||Math.abs(dy)>5) isDrag = true;
                cam.x -= dx/(45*cam.zoom); cam.y -= dy/(45*cam.zoom);
                touches.set(t.identifier, {x:t.clientX, y:t.clientY});
                render();
            }
        }
    }, {passive:false});

    container.addEventListener('touchend', e => {
        if(!isDrag && e.changedTouches.length===1){
            const t = e.changedTouches[0], r = cvs.getBoundingClientRect();
            onClick(t.clientX-r.left, t.clientY-r.top);
        }
        for(let t of e.changedTouches) touches.delete(t.identifier);
    });

    function onClick(sx, sy){
        if(!g_active || g_turn !== g_side) return;
        const s = 45 * cam.zoom;
        const gx = Math.floor((sx-(cvs.width/2 - cam.x*s))/s);
        const gy = Math.floor((sy-(cvs.height/2 - cam.y*s))/s);
        if(gx<0||gx>=128||gy<0||gy>=128||g_board.find(p=>p.x===gx&&p.y===gy)) return;

        let isP = false;
        const lastOpp = g_board.filter(p=>p.player!==g_side).pop();
        if(lastOpp){
            const dx = gx-lastOpp.x, dy = gy-lastOpp.y;
            if((lastOpp.direction===0&&dy===-1)||(lastOpp.direction===1&&dx===1)||(lastOpp.direction===2&&dy===1)||(lastOpp.direction===3&&dx===-1)) isP=true;
        }
        if(isP && g_pairs[g_side]>=3) return alert("ÈÄ£Á∂ö„ÅÆÂØæ„ÅØ3Âõû„Åæ„Åß„Åß„Åô");

        const np = [...g_pairs]; np[g_side] = isP ? np[g_side]+1 : 0;
        const piece = {x:gx, y:gy, direction:selDir, player:g_side};
        socket.emit('placePiece', { roomId: document.getElementById('ui-room').textContent, piece, consecutivePairs:np });
        if(winCheck(g_board.concat(piece), g_side)) socket.emit('declareWin', { roomId: document.getElementById('ui-room').textContent, winner:g_side });
    }

    function winCheck(all, side){
        const mine = all.filter(m=>m.player===side);
        const dirs = [[1,0],[0,1],[1,1],[1,-1]];
        for(let m of mine){
            for(let [vx,vy] of dirs){
                let chain = [m];
                for(let i=1;i<5;i++){
                    const f = mine.find(x=>x.x===m.x+vx*i && x.y===m.y+vy*i);
                    if(f) chain.push(f); else break;
                }
                if(chain.length>=5){
                    for(let c1 of chain) for(let c2 of all) if(c1!==c2 && checkFace(c1,c2)) return true;
                }
            }
        }
        return false;
    }

    function uiSync() {
        const lb = document.getElementById('ui-turn');
        lb.textContent = (g_turn===g_side) ? "‚òÖ „ÅÇ„Å™„Åü„ÅÆÁï™" : "Áõ∏Êâã„ÅÆÁï™";
        lb.style.color = (g_turn===g_side) ? "var(--accent)" : "#64748b";
        document.getElementById('ui-pairs').textContent = `PAIRS: B ${g_pairs[0]} / W ${g_pairs[1]}`;
    }
    function setDir(d) { selDir=d; document.querySelectorAll('.dir-btn').forEach((b,i)=>b.classList.toggle('active',i===d)); }
    function resize() { cvs.width=container.clientWidth; cvs.height=container.clientHeight; render(); }
    window.onresize = resize;
</script>
</body>
</html>

