<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LANDOLT ONLINE GOMOKU</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --main: #2563eb; --bg: #0f172a; }
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body { font-family:sans-serif; background:var(--bg); height:100vh; display:flex; justify-content:center; overflow:hidden; }
        .app { width:100%; max-width:500px; background:#fff; height:100%; display:flex; flex-direction:column; position:relative; }
        
        /* LOBBY */
        #lobby { flex:1; display:flex; flex-direction:column; padding:20px; overflow:hidden; }
        .setup-area { background:#f1f5f9; padding:15px; border-radius:12px; margin-bottom:15px; flex-shrink:0; }
        input, select { width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:1px solid #ccc; font-size:16px; }
        .btn-create { width:100%; padding:12px; background:var(--main); color:#fff; border:none; border-radius:8px; font-weight:bold; cursor:pointer; }
        
        #room-list { flex:1; overflow-y:auto; border:1px solid #ddd; border-radius:12px; background:#fff; }
        .room-item { padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; }
        
        /* GAME */
        #game { display:none; flex-direction:column; height:100%; position:absolute; inset:0; background:#fff; z-index:100; }
        .game-header { padding:10px 15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; }
        #canvas-area { flex:1; background:#064e3b; position:relative; overflow:hidden; touch-action:none; }
        canvas { display:block; width:100%; height:100%; }
        
        .game-footer { padding:15px 20px 40px; border-top:1px solid #eee; }
        .timer-container { height:8px; background:#eee; border-radius:4px; margin-bottom:15px; overflow:hidden; }
        #timer-bar { height:100%; background:var(--main); width:100%; transition: width 1s linear; }
        
        .dir-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:15px; }
        .dir-btn { height:50px; border:2px solid #ddd; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:24px; cursor:pointer; }
        .dir-btn.active { background:var(--main); color:#fff; border-color:var(--main); }
    </style>
</head>
<body>

<div class="app">
    <div id="lobby">
        <h2 style="margin-bottom:15px; text-align:center;">LANDOLT ONLINE</h2>
        <div class="setup-area">
            <input type="text" id="roomIdInput" placeholder="ルーム名">
            <input type="password" id="passwordInput" placeholder="パスワード(任意)">
            <select id="timeLimitSelect">
                <option value="none">時間無制限</option>
                <option value="30">30秒</option>
                <option value="60" selected>60秒</option>
                <option value="120">120秒</option>
            </select>
            <button class="btn-create" onclick="createRoom()">ルームを作成</button>
        </div>
        <div id="room-list"></div>
    </div>

    <div id="game">
        <div class="game-header">
            <div><b id="display-rid">---</b><br><small id="display-status">待機中</small></div>
            <div id="display-time" style="font-weight:bold; font-size:20px;">--</div>
        </div>
        <div class="timer-container"><div id="timer-bar"></div></div>
        <div id="canvas-area"><canvas id="stage"></canvas></div>
        <div class="game-footer">
            <div id="display-pairs" style="text-align:center; font-weight:bold; margin-bottom:10px;">PAIRS: 0 / 0</div>
            <div class="dir-grid">
                <div id="d0" class="dir-btn active" onclick="setDir(0)">↑</div>
                <div id="d1" class="dir-btn" onclick="setDir(1)">→</div>
                <div id="d2" class="dir-btn" onclick="setDir(2)">↓</div>
                <div id="d3" class="dir-btn" onclick="setDir(3)">←</div>
            </div>
            <button onclick="location.reload()" style="width:100%; border:none; background:none; color:red; cursor:pointer;">退室する</button>
        </div>
    </div>
</div>

<script>
    const socket = io();
    const cvs = document.getElementById('stage'), ctx = cvs.getContext('2d', {alpha:false});
    const area = document.getElementById('canvas-area');

    let g_side = null, g_turn = 0, g_board = [], g_pairs = [0, 0], g_active = false, g_limit = "none";
    let cam = {x:64, y:64, zoom:1.0}, selDir = 0;
    let touch = { isMove: false, lx: 0, ly: 0, ld: 0, down: false };

    // --- Lobby ---
    socket.on('updateRoomList', list => {
        const target = document.getElementById('room-list');
        target.innerHTML = list.length ? "" : "<p style='text-align:center;padding:20px;color:#999;'>空いているルームはありません</p>";
        list.forEach(r => {
            const div = document.createElement('div');
            div.className = 'room-item';
            div.innerHTML = `<div><b>${r.id}</b><br><small>${r.status} (${r.count}/2)</small></div>
                             <button onclick="joinRoom('${r.id}', ${r.hasPw})" style="padding:8px 12px; background:#16a34a; color:#fff; border:none; border-radius:6px; cursor:pointer;">参加</button>`;
            target.appendChild(div);
        });
    });

    function createRoom() {
        const id = document.getElementById('roomIdInput').value;
        const pw = document.getElementById('passwordInput').value;
        const limit = document.getElementById('timeLimitSelect').value;
        if(!id) return alert("ルーム名を入力してください");
        socket.emit('createRoom', { roomId: id, password: pw, timeLimit: limit });
    }

    function joinRoom(id, hp) {
        const pw = hp ? prompt("パスワード:") : "";
        if(pw !== null) socket.emit('joinRoom', { roomId: id, password: pw });
    }

    // --- Game Logic ---
    socket.on('roomJoined', d => {
        g_side = d.playerIndex;
        g_limit = d.timeLimit;
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('game').style.display = 'flex';
        document.getElementById('display-rid').textContent = d.roomId;
        if(g_limit === "none") {
            document.getElementById('display-time').textContent = "∞";
            document.getElementById('timer-bar').style.width = "100%";
        }
        resize();
    });

    socket.on('gameStart', () => { g_active = true; updateUI(); draw(); });
    socket.on('timerUpdate', d => {
        if(g_limit === "none") return;
        document.getElementById('display-time').textContent = d.timeLeft + "s";
        document.getElementById('timer-bar').style.width = (d.timeLeft / parseInt(g_limit) * 100) + "%";
    });

    socket.on('moveMade', d => {
        g_board.push(d.piece); g_turn = d.nextTurn; g_pairs = d.consecutivePairs;
        updateUI(); draw();
    });

    socket.on('gameOver', d => {
        alert(d.reason === "TIMEOUT" ? "時間切れ！" : (d.winner === g_side ? "勝利！" : "敗北..."));
        location.reload();
    });

    socket.on('playerLeft', () => { alert("相手が退出しました"); location.reload(); });
    socket.on('error_msg', m => alert(m));

    // --- Interaction ---
    function getXY(e) {
        const r = cvs.getBoundingClientRect();
        const t = e.touches ? e.touches[0] : e;
        return { x: t.clientX - r.left, y: t.clientY - r.top };
    }

    area.addEventListener('touchstart', e => {
        if(e.touches.length === 1) {
            touch.isMove = false;
            const p = getXY(e);
            touch.lx = p.x; touch.ly = p.y;
        } else if(e.touches.length === 2) {
            touch.ld = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
        }
    }, {passive:false});

    area.addEventListener('touchmove', e => {
        e.preventDefault();
        if(e.touches.length === 1) {
            const p = getXY(e);
            const dx = p.x - touch.lx; const dy = p.y - touch.ly;
            if(Math.abs(dx) > 5 || Math.abs(dy) > 5) touch.isMove = true;
            cam.x -= dx / (45 * cam.zoom); cam.y -= dy / (45 * cam.zoom);
            touch.lx = p.x; touch.ly = p.y;
            draw();
        } else if(e.touches.length === 2) {
            const d = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
            cam.zoom = Math.min(Math.max(cam.zoom * (d / touch.ld), 0.5), 3.0);
            touch.ld = d;
            draw();
        }
    }, {passive:false});

    area.addEventListener('touchend', e => {
        if(!touch.isMove && e.touches.length === 0) {
            const p = getXY(e.changedTouches[0]);
            placePiece(p.x, p.y);
        }
    });

    area.addEventListener('mousedown', e => {
        touch.isMove = false; touch.lx = e.clientX; touch.ly = e.clientY; touch.down = true;
    });
    window.addEventListener('mousemove', e => {
        if(!touch.down) return;
        const dx = e.clientX - touch.lx; const dy = e.clientY - touch.ly;
        if(Math.abs(dx) > 5 || Math.abs(dy) > 5) touch.isMove = true;
        cam.x -= dx / (45 * cam.zoom); cam.y -= dy / (45 * cam.zoom);
        touch.lx = e.clientX; touch.ly = e.clientY;
        draw();
    });
    window.addEventListener('mouseup', e => {
        if(touch.down && !touch.isMove) {
            const r = cvs.getBoundingClientRect();
            placePiece(e.clientX - r.left, e.clientY - r.top);
        }
        touch.down = false;
    });

    function placePiece(sx, sy) {
        if(!g_active || g_turn !== g_side) return;
        const s = 45 * cam.zoom;
        const gx = Math.floor((sx - (cvs.width/2 - cam.x*s)) / s);
        const gy = Math.floor((sy - (cvs.height/2 - cam.y*s)) / s);
        
        if(gx<0 || gx>=128 || gy<0 || gy>=128) return;
        if(g_board.find(p => p.x === gx && p.y === gy)) return;

        let isP = false;
        const last = g_board.filter(p => p.player !== g_side).pop();
        if(last) {
            const dx = gx-last.x, dy = gy-last.y;
            if((last.direction===0 && dy===-1) || (last.direction===1 && dx===1) || (last.direction===2 && dy===1) || (last.direction===3 && dx===-1)) isP = true;
        }
        if(isP && g_pairs[g_side] >= 3) return alert("対は3回までです");

        const np = [...g_pairs]; np[g_side] = isP ? np[g_side]+1 : 0;
        const piece = { x: gx, y: gy, direction: selDir, player: g_side };
        socket.emit('placePiece', { roomId: document.getElementById('display-rid').textContent, piece, consecutivePairs: np });
    }

    // --- Rendering ---
    function draw() {
        if(!cvs.width) return;
        ctx.fillStyle = "#020617"; ctx.fillRect(0,0,cvs.width,cvs.height);
        const s = 45 * cam.zoom, ox = cvs.width/2 - cam.x*s, oy = cvs.height/2 - cam.y*s;
        ctx.fillStyle = "#064e3b"; ctx.fillRect(ox, oy, 128*s, 128*s);
        ctx.strokeStyle = "rgba(255,255,255,0.1)"; ctx.beginPath();
        for(let i=0;i<=128;i++){ ctx.moveTo(ox+i*s, oy); ctx.lineTo(ox+i*s, oy+128*s); ctx.moveTo(ox, oy+i*s); ctx.lineTo(ox+128*s, oy+i*s); } ctx.stroke();
        g_board.forEach(p => {
            const px = ox + p.x*s + s/2, py = oy + p.y*s + s/2;
            ctx.beginPath(); ctx.arc(px, py, s*0.35, 0, 7); ctx.strokeStyle = p.player===0?"#000":"#fff"; ctx.lineWidth=s*0.1; ctx.stroke();
            ctx.beginPath(); const a = [-1.57, 0, 1.57, 3.14][p.direction];
            ctx.arc(px, py, s*0.35, a-0.4, a+0.4); ctx.strokeStyle = "#fbbf24"; ctx.lineWidth=s*0.13; ctx.stroke();
        });
    }

    function updateUI() {
        document.getElementById('display-status').textContent = g_turn===g_side?"★あなたの番です":"相手が考えています";
        document.getElementById('display-pairs').textContent = `PAIRS: ${g_pairs[0]} / ${g_pairs[1]}`;
    }
    function setDir(d) { selDir=d; document.querySelectorAll('.dir-btn').forEach((b,i)=>b.classList.toggle('active', i===d)); }
    function resize() { cvs.width=area.clientWidth; cvs.height=area.clientHeight; draw(); }
    window.onresize = resize;
</script>
</body>
</html>
