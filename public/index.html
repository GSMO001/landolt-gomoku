<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LANDOLT GOMOKU ONLINE - PRO</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            --primary: #059669; --primary-dark: #064e3b;
            --bg-canvas: #14532d; --bg-app: #f8fafc;
            --danger: #ef4444; --accent: #3b82f6;
            --white: #ffffff; --text: #0f172a;
        }
        * { margin:0; padding:0; box-sizing:border-box; -webkit-touch-callout:none; user-select:none; touch-action:none; }
        body { font-family: sans-serif; background:#020617; height:100vh; display:flex; justify-content:center; overflow:hidden; }
        
        .shell { width:100%; max-width:550px; height:100%; background:var(--white); display:flex; flex-direction:column; position:relative; }
        
        /* --- Lobby Style --- */
        #lobby { flex:1; display:flex; flex-direction:column; padding:24px; overflow:hidden; }
        .logo { font-size:26px; font-weight:900; text-align:center; color:var(--text); margin-bottom:20px; }
        
        .card { background:#f1f5f9; border-radius:20px; padding:20px; margin-bottom:20px; border:1px solid #e2e8f0; }
        .row { margin-bottom:12px; }
        .row label { display:block; font-size:11px; font-weight:800; color:#64748b; margin-bottom:4px; }
        input, select { width:100%; padding:12px; border-radius:12px; border:2px solid #e2e8f0; font-size:16px; outline:none; }
        input:focus { border-color:var(--accent); }
        
        .search-container { margin-bottom:15px; }
        #search-box { background:#f0f9ff; border-color:#bae6fd; }
        
        /* „Çπ„ÇØ„É≠„Éº„É´ÂèØËÉΩ„Å™„Ç®„É™„Ç¢ */
        #room-list-scroll { flex:1; overflow-y:auto; padding-right:5px; border-radius:15px; }
        #room-list-scroll::-webkit-scrollbar { width:5px; }
        #room-list-scroll::-webkit-scrollbar-thumb { background:#cbd5e1; border-radius:10px; }
        
        .room-card { 
            background:white; border:2px solid #f1f5f9; border-radius:16px; padding:16px; margin-bottom:12px; 
            display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 4px rgba(0,0,0,0.02);
        }
        .room-info b { color:var(--text); font-size:16px; }
        .room-info p { font-size:12px; color:#64748b; font-weight:bold; }

        .btn { 
            width:100%; padding:15px; background:var(--primary); color:white; border:none; 
            border-radius:14px; font-weight:900; font-size:17px; cursor:pointer; 
            box-shadow:0 4px 0 var(--primary-dark); transition:0.1s;
        }
        .btn:active { transform:translateY(2px); box-shadow:0 2px 0 var(--primary-dark); }
        .btn-small { width:auto; padding:8px 16px; font-size:13px; }

        /* --- Game Style --- */
        #game { display:none; flex-direction:column; height:100%; }
        .header { padding:15px 20px; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center; }
        #timer { font-size:30px; font-weight:900; color:var(--danger); }
        
        #view-box { flex:1; background:var(--bg-canvas); position:relative; }
        canvas { display:block; width:100%; height:100%; }
        
        .footer { background:white; padding:15px 20px 45px 20px; border-top:1px solid #e2e8f0; }
        .control-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:20px; }
        .dir-btn { 
            height:55px; border:2px solid #f1f5f9; background:white; border-radius:14px; 
            font-size:24px; display:flex; align-items:center; justify-content:center; color:#94a3b8;
        }
        .dir-btn.active { border-color:var(--accent); color:var(--accent); background:#eff6ff; }
        
        /* „Çπ„ÉÜ„Éº„Çø„ÇπË°å„Å®LEAVE„Éú„Çø„É≥ */
        .status-bar { display:flex; justify-content:space-between; align-items:center; }
        .stats-text { font-size:18px; font-weight:900; color:#475569; }
        .leave-btn { 
            font-size:24px; font-weight:900; color:var(--danger); border:none; background:none; 
            cursor:pointer; padding:5px 10px;
        }
        
        /* Modal */
        .overlay { display:none; position:absolute; inset:0; background:rgba(0,0,0,0.85); z-index:100; align-items:center; justify-content:center; padding:40px; }
        .modal { background:white; width:100%; border-radius:24px; padding:30px; text-align:center; }
    </style>
</head>
<body>

<div class="shell">
    <div id="lobby">
        <div class="logo">LANDOLT ONLINE PRO</div>
        <div class="card">
            <div class="row"><label>ROOM NAME</label><input type="text" id="in-room-id" placeholder="20ÊñáÂ≠ó‰ª•ÂÜÖ"></div>
            <div class="row"><label>PASSWORD (OPTIONAL)</label><input type="password" id="in-room-pw"></div>
            <div class="row">
                <label>TIME LIMIT</label>
                <select id="in-room-limit">
                    <option value="30">30 Seconds</option>
                    <option value="60">60 Seconds</option>
                    <option value="free">No Limit</option>
                </select>
            </div>
            <button class="btn" onclick="apiCreate()">CREATE NEW MATCH</button>
        </div>
        <div class="search-container"><input type="text" id="search-box" placeholder="üîç „É´„Éº„É†„ÇíÊ§úÁ¥¢..." oninput="uiUpdateList()"></div>
        <div id="room-list-scroll"><div id="room-list-target"></div></div>
    </div>

    <div id="game">
        <div class="header">
            <div><b id="ui-room-name">---</b><p id="ui-status" style="font-size:11px; font-weight:800; color:#64748b;">WAITING</p></div>
            <div id="timer">--</div>
        </div>
        <div id="view-box"><canvas id="main-cvs"></canvas></div>
        <div class="footer">
            <div class="control-grid">
                <div class="dir-btn active" id="db0" onclick="uiSetDir(0)">‚Üë</div>
                <div class="dir-btn" id="db1" onclick="uiSetDir(1)">‚Üí</div>
                <div class="dir-btn" id="db2" onclick="uiSetDir(2)">‚Üì</div>
                <div class="dir-btn" id="db3" onclick="uiSetDir(3)">‚Üê</div>
            </div>
            <div class="status-bar">
                <span class="stats-text" id="ui-pair-stats">PAIRS: B 0 / W 0</span>
                <button class="leave-btn" onclick="location.reload()">LEAVE</button>
            </div>
        </div>
    </div>

    <div id="modal-end" class="overlay">
        <div class="modal">
            <h2 id="end-title" style="font-size:32px; margin-bottom:10px;">END</h2>
            <p id="end-desc" style="color:#64748b; font-weight:bold; margin-bottom:25px;"></p>
            <button class="btn" onclick="location.reload()">LOBBY</button>
        </div>
    </div>
</div>

<script>
    const socket = io();
    const cvs = document.getElementById('main-cvs');
    const ctx = cvs.getContext('2d', { alpha: false });
    const viewBox = document.getElementById('view-box');
    
    let state = {
        rooms: [], side: null, turn: 0, board: [], pairs: [0, 0], active: false,
        cam: { x: 64, y: 64, zoom: 1.0 }, selDir: 0, touches: new Map(), drag: false
    };

    // --- Lobby APIs ---
    socket.on('updateRoomList', data => { state.rooms = data; uiUpdateList(); });
    function uiUpdateList() {
        const target = document.getElementById('room-list-target');
        const query = document.getElementById('search-box').value.toLowerCase();
        target.innerHTML = "";
        const filtered = state.rooms.filter(r => r.id.toLowerCase().includes(query));
        if(!filtered.length) { target.innerHTML = `<p style="text-align:center; padding:30px; color:#94a3b8;">No Rooms Found</p>`; return; }
        filtered.forEach(r => {
            const div = document.createElement('div');
            div.className = 'room-card';
            div.innerHTML = `
                <div class="room-info"><b>${r.id} ${r.hasPassword?'üîí':''}</b><p>${r.status} (${r.playerCount}/2) | ${r.timeLimit}s</p></div>
                <button class="btn btn-small" onclick="apiJoin('${r.id}', ${r.hasPassword})" ${r.playerCount>=2?'disabled':''}>JOIN</button>
            `;
            target.appendChild(div);
        });
    }

    function apiCreate() {
        const id = document.getElementById('in-room-id').value;
        const pw = document.getElementById('in-room-pw').value;
        const lim = document.getElementById('in-room-limit').value;
        if(!id) return alert("Enter Room Name");
        socket.emit('createRoom', { roomId: id, password: pw, settings: { timeLimit: lim } });
    }
    function apiJoin(id, hp) { const pw = hp ? prompt("PW:") : ""; if(pw!==null) socket.emit('joinRoom', { roomId: id, password: pw }); }

    // --- Game Logic ---
    socket.on('roomJoined', data => {
        state.side = data.playerIndex;
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('game').style.display = 'flex';
        document.getElementById('ui-room-name').textContent = data.roomId;
        uiResize();
    });
    socket.on('gameStart', () => { state.active = true; uiUpdate(); gameRender(); });
    socket.on('moveMade', data => {
        state.board.push(data.piece); state.turn = data.nextTurn; state.pairs = data.consecutivePairs;
        if(data.piece.player !== state.side) { state.cam.x = data.piece.x; state.cam.y = data.piece.y; }
        uiUpdate(); gameRender();
    });
    socket.on('timerUpdate', t => document.getElementById('timer').textContent = t + "s");
    socket.on('gameOver', data => {
        state.active = false;
        document.getElementById('modal-end').style.display = 'flex';
        document.getElementById('end-title').textContent = (data.winner === state.side) ? "WINNER!" : "LOSER...";
        document.getElementById('end-desc').textContent = (data.reason === "timeout") ? "TIME OVER" : "CHECKMATE";
    });
    socket.on('playerLeft', () => { alert("OPPONENT LEFT"); location.reload(); });
    socket.on('error_msg', m => alert(m));

    // --- Render Engine ---
    function gameRender() {
        if(!cvs.width) return;
        ctx.fillStyle = "#020617"; ctx.fillRect(0,0,cvs.width,cvs.height);
        const s = 45 * state.cam.zoom;
        const ox = cvs.width/2 - state.cam.x*s, oy = cvs.height/2 - state.cam.y*s;
        
        ctx.fillStyle = "#14532d"; ctx.fillRect(ox, oy, 128*s, 128*s);
        ctx.strokeStyle = "rgba(255,255,255,0.1)"; ctx.lineWidth=1;
        ctx.beginPath();
        for(let i=0; i<=128; i++){
            ctx.moveTo(ox+i*s, oy); ctx.lineTo(ox+i*s, oy+128*s);
            ctx.moveTo(ox, oy+i*s); ctx.lineTo(ox+128*s, oy+i*s);
        }
        ctx.stroke();

        // Pairs Line
        ctx.save(); ctx.setLineDash([4,4]); ctx.strokeStyle="#ef4444"; ctx.lineWidth=2;
        state.board.forEach((p,i)=>{
            for(let j=i+1; j<state.board.length; j++){
                const q = state.board[j];
                if(p.player === q.player && checkFace(p, q)){
                    ctx.beginPath(); ctx.moveTo(ox+p.x*s+s/2, oy+p.y*s+s/2); ctx.lineTo(ox+q.x*s+s/2, oy+q.y*s+s/2); ctx.stroke();
                }
            }
        });
        ctx.restore();

        // Pieces
        state.board.forEach(p=>{
            const px = ox+p.x*s+s/2, py = oy+p.y*s+s/2;
            ctx.beginPath(); ctx.arc(px, py, s*0.35, 0, Math.PI*2);
            ctx.strokeStyle = p.player===0?"#000":"#fff"; ctx.lineWidth=s*0.12; ctx.stroke();
            ctx.beginPath(); const a = [-Math.PI/2, 0, Math.PI/2, Math.PI][p.direction];
            ctx.arc(px, py, s*0.35, a-0.45, a+0.45); ctx.strokeStyle="#fbbf24"; ctx.lineWidth=s*0.15; ctx.stroke();
        });
    }

    function checkFace(a,b){
        const dx = b.x-a.x, dy = b.y-a.y;
        if(Math.abs(dx)>1||Math.abs(dy)>1) return false;
        if(dx===0&&dy===-1) return a.direction===0&&b.direction===2;
        if(dx===1&&dy===0) return a.direction===1&&b.direction===3;
        if(dx===0&&dy===1) return a.direction===2&&b.direction===0;
        if(dx===-1&&dy===0) return a.direction===3&&b.direction===1;
        return false;
    }

    // --- Input Control ---
    viewBox.addEventListener('touchstart', e=>{
        e.preventDefault(); state.drag=false;
        for(let t of e.changedTouches) state.touches.set(t.identifier, {x:t.clientX, y:t.clientY});
    }, {passive:false});

    viewBox.addEventListener('touchmove', e=>{
        e.preventDefault();
        if(e.touches.length===1){
            const t = e.touches[0], last = state.touches.get(t.identifier);
            if(last){
                const dx = t.clientX-last.x, dy = t.clientY-last.y;
                if(Math.abs(dx)>4||Math.abs(dy)>4) state.drag=true;
                state.cam.x -= dx/(45*state.cam.zoom); state.cam.y -= dy/(45*state.cam.zoom);
                state.touches.set(t.identifier, {x:t.clientX, y:t.clientY});
                gameRender();
            }
        }
    }, {passive:false});

    viewBox.addEventListener('touchend', e=>{
        if(!state.drag && e.changedTouches.length===1){
            const t = e.changedTouches[0], r = cvs.getBoundingClientRect();
            clickBoard(t.clientX-r.left, t.clientY-r.top);
        }
        for(let t of e.changedTouches) state.touches.delete(t.identifier);
    });

    function clickBoard(sx, sy){
        if(!state.active || state.turn !== state.side) return;
        const s = 45 * state.cam.zoom;
        const gx = Math.floor((sx-(cvs.width/2 - state.cam.x*s))/s);
        const gy = Math.floor((sy-(cvs.height/2 - state.cam.y*s))/s);
        if(gx<0||gx>=128||gy<0||gy>=128||state.board.find(p=>p.x===gx&&p.y===gy)) return;

        let isP = false;
        const lastOpp = state.board.filter(p=>p.player!==state.side).pop();
        if(lastOpp){
            const dx = gx-lastOpp.x, dy = gy-lastOpp.y;
            if((lastOpp.direction===0&&dy===-1)||(lastOpp.direction===1&&dx===1)||(lastOpp.direction===2&&dy===1)||(lastOpp.direction===3&&dx===-1)) isP=true;
        }
        if(isP && state.pairs[state.side]>=3) return alert("LIMIT: 3 PAIRS");

        const np = [...state.pairs]; np[state.side] = isP ? np[state.side]+1 : 0;
        const piece = {x:gx, y:gy, direction:state.selDir, player:state.side};
        socket.emit('placePiece', { roomId: document.getElementById('ui-room-name').textContent, piece, consecutivePairs:np });
        if(winCheck(state.board.concat(piece), state.side)) socket.emit('declareWin', { roomId: document.getElementById('ui-room-name').textContent, winner:state.side });
    }

    function winCheck(all, side){
        const mine = all.filter(m=>m.player===side);
        const dirs = [[1,0],[0,1],[1,1],[1,-1]];
        for(let m of mine){
            for(let [vx,vy] of dirs){
                let chain = [m];
                for(let i=1; i<5; i++){
                    const f = mine.find(x=>x.x===m.x+vx*i && x.y===m.y+vy*i);
                    if(f) chain.push(f); else break;
                }
                if(chain.length>=5){
                    for(let c1 of chain) for(let c2 of all) if(c1!==c2 && checkFace(c1,c2)) return true;
                }
            }
        }
        return false;
    }

    function uiUpdate(){
        const label = document.getElementById('ui-status');
        label.textContent = (state.turn === state.side) ? "‚òÖ YOUR TURN" : "ENEMY TURN";
        label.style.color = (state.turn === state.side) ? "var(--accent)" : "#64748b";
        document.getElementById('ui-pair-stats').textContent = `PAIRS: B ${state.pairs[0]} / W ${state.pairs[1]}`;
    }
    function uiSetDir(d){ state.selDir=d; document.querySelectorAll('.dir-btn').forEach((b,i)=>b.classList.toggle('active',i===d)); }
    function uiResize(){ cvs.width=viewBox.clientWidth; cvs.height=viewBox.clientHeight; gameRender(); }
    window.onresize = uiResize;
</script>
</body>
</html>
